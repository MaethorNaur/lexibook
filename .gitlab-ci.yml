cache:
    key: "$CI_JOB_NAME"
    untracked: true
    paths:
    - $HOME/.cargo/
    - target/

stages: 
 - test
 - build
 - deploy   
.cargo_test_template: &cargo_test
  stage: test
  script:
  - rustc --version && cargo --version
  - cargo build
  - cargo test --verbose

test:stable:
  except:
    - tags
    - master
  image: "rust:latest"
  <<: *cargo_test


lint:rustfmt:
  except:
    - tags
    - master
  stage: test
  image: "guangie88/rustfmt-clippy:stable"
  script:
    - cargo fmt -- --check

lint:clippy:
  except:
    - tags
    - master
  stage: test
  image: "guangie88/rustfmt-clippy:stable"
  script:
    - cargo clippy --all-features -- -D warnings # Turn all warnings into errors

build:wasm:
  except:
    - tags
  stage: build
  image: "rust:latest"
  only:
    - master
  before_script:
    - rustup target add wasm32-unknown-unknown
    - curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
  script:
    - cd src/wasm
    - wasm-pack build
  artifacts:
    expire_in: 1h
    paths:
      - src/wasm/pkg/ 
pages:
  except:
    - tags
  only:
    - master
  stage: deploy
  image: node
  dependencies:
    - build:wasm
  script:
    - cd src/wasm/public
    - npm i
    - npm run build
    - cd ../../../
    - rm -rf public
    - mv src/wasm/public/dist public/
  artifacts:
    paths:
      - public

